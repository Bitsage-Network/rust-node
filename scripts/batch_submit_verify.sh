#!/bin/bash
# Batch submit and verify proofs on Starknet from H100
source /home/shadeform/.starkli/env

CONTRACT="0x017ada59ab642b53e6620ef2026f21eb3f2d1a338d6e85cb61d5bcd8dfbebc8b"
ACCOUNT="/tmp/fetched_account.json"
PRIVATE_KEY="0x02c22c55e9c3aae8293e99a8b5d4ee1862595936f5f15f7d1f6ddcf8b216c44d"
RPC="https://rpc.starknet-testnet.lava.build"

echo "╔══════════════════════════════════════════════════════════════════════╗"
echo "║        OBELYSK BATCH PROOF SUBMISSION - H100 GPU                     ║"
echo "╚══════════════════════════════════════════════════════════════════════╝"
echo ""

START_JOB=300
END_JOB=309
VERIFIED=0

START_TIME=$(date +%s)

# Submit jobs
echo "=== Phase 1: Submitting 10 jobs ==="
for i in $(seq $START_JOB $END_JOB); do
  echo -n "  Job $i: "
  TX=$(starkli invoke $CONTRACT submit_proof_job $i 0 2 0x09cd58c2 0x09cd58c2 0 1000000 0 0 0 1800000000 1 0 0 \
    --account $ACCOUNT --private-key $PRIVATE_KEY --rpc $RPC 2>&1 | grep "Invoke" | awk '{print $3}')
  if [ -n "$TX" ]; then
    echo "TX: ${TX:0:20}..."
    sleep 3
  else
    echo "FAILED"
  fi
done

echo ""
echo "=== Phase 2: Waiting for jobs to be mined... ==="
sleep 15

# Verify proofs
echo ""
echo "=== Phase 3: Verifying proofs with PoW nonce 980 ==="
for i in $(seq $START_JOB $END_JOB); do
  echo -n "  Job $i: "
  TX=$(starkli invoke $CONTRACT verify_proof $i 0 48 \
    0x0000000000000000000000000000000000000000000000000000000009cd58c2 \
    0x0000000000000000000000000000000000000000000000000000000009cd58c2 \
    0x0000000000000000000000000000000000000000000000000000000009cd58c2 \
    0x00000000000000000000000000000000000000000000000000000000499602d2 \
    0x000000000000000000000000000000000000000000000000000000000d5454a2 \
    0x0000000000000000000000000000000000000000000000000000000027bb29d4 \
    0x0000000000000000000000000000000000000000000000000000000032523b20 \
    0x0000000000000000000000000000000000000000000000000000000008688110 \
    0x00000000000000000000000000000000000000000000000000000000137b78d0 \
    0x00000000000000000000000000000000000000000000000000000000038736c9 \
    0x0000000000000000000000000000000000000000000000000000000009cd58c2 \
    0x000000000000000000000000000000000000000000000000000000004996330b \
    0x000000000000000000000000000000000000000000000000000000004aaa462f \
    0x000000000000000000000000000000000000000000000000000000004a9681bf \
    0x0000000000000000000000000000000000000000000000000000000012493770 \
    0x0000000000000000000000000000000000000000000000000000000040f86902 \
    0x000000000000000000000000000000000000000000000000000000002fe0c5f4 \
    0x00000000000000000000000000000000000000000000000000000000036d3e5c \
    0x0000000000000000000000000000000000000000000000000000000009cd58c2 \
    0x0000000000000000000000000000000000000000000000000000000049966344 \
    0x00000000000000000000000000000000000000000000000000000000104931b6 \
    0x0000000000000000000000000000000000000000000000000000000066d6e482 \
    0x0000000000000000000000000000000000000000000000000000000009cd58c2 \
    0x000000000000000000000000000000000000000000000000000000004996937d \
    0x000000000000000000000000000000000000000000000000000000002be1493f \
    0x000000000000000000000000000000000000000000000000000000003d88092d \
    0x00000000000000000000000000000000000000000000000000000000574a5e80 \
    0x000000000000000000000000000000000000000000000000000000007fa7cca6 \
    0x0000000000000000000000000000000000000000000000000000000009cd58c2 \
    0x000000000000000000000000000000000000000000000000000000004996c3b6 \
    0x00000000000000000000000000000000000000000000000000000000430bacd8 \
    0x00000000000000000000000000000000000000000000000000000000555b0378 \
    0x0000000000000000000000000000000000000000000000000000000000000000 \
    0x0000000000000000000000000000000000000000000000000000000000000000 \
    0x0000000000000000000000000000000000000000000000000000000041f04a37 \
    0x0000000000000000000000000000000000000000000000000000000041f04a37 \
    0x0000000000000000000000000000000000000000000000000000000000000001 \
    0x0000000000000000000000000000000000000000000000000000000000000000 \
    0x0000000000000000000000000000000000000000000000000000000041f04a37 \
    0x0000000000000000000000000000000000000000000000000000000041f04a37 \
    0x0000000000000000000000000000000000000000000000000000000000000002 \
    0x0000000000000000000000000000000000000000000000000000000000000000 \
    0x0000000000000000000000000000000000000000000000000000000041f04a37 \
    0x0000000000000000000000000000000000000000000000000000000041f04a37 \
    0x000000000000000000000000000000000000000000000000000000000000000b \
    0x0000000000000000000000000000000000000000000000000000000009ed19a7 \
    0x0000000000000000000000000000000000000000000000000000000001cf8c09 \
    0x00000000000000000000000000000000000000000000000000000000000003d4 \
    --account $ACCOUNT --private-key $PRIVATE_KEY --rpc $RPC 2>&1 | grep "Invoke" | awk '{print $3}')
  if [ -n "$TX" ]; then
    echo "TX: ${TX:0:20}..."
    sleep 3
  else
    echo "FAILED"
  fi
done

echo ""
echo "=== Phase 4: Waiting for verifications... ==="
sleep 15

# Check statuses
echo ""
echo "=== Phase 5: Checking final statuses ==="
for i in $(seq $START_JOB $END_JOB); do
  STATUS=$(starkli call $CONTRACT get_proof_status $i 0 --rpc $RPC 2>&1 | grep "0x" | tr -d '[]" ')
  if [ "$STATUS" = "0x0000000000000000000000000000000000000000000000000000000000000002" ]; then
    echo "  Job $i: VERIFIED ✓"
    ((VERIFIED++))
  else
    echo "  Job $i: Status $STATUS"
  fi
done

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "══════════════════════════════════════════════════════════════════════"
echo "RESULTS:"
echo "  Total jobs: 10"
echo "  Verified: $VERIFIED"
echo "  Total time: ${DURATION}s"
echo "══════════════════════════════════════════════════════════════════════"
